name: Download Ubuntu 22.04 APT Packages

on:
  workflow_dispatch:
    inputs:
      mirror_url:
        description: 'Mirror URL'
        required: true
        default: 'jammy main'

jobs:
  apt-mirror:
    runs-on: ubuntu-22.04

    steps:
    - name: Set up repository
      run: sudo apt-get update

    - name: Install apt-mirror and grep
      run: sudo apt-get install -y apt-mirror grep

    - name: Create mirror directory
      run: |
        sudo mkdir -p /mnt/ubuntu-mirror
        sudo chown -R $USER:$USER /mnt/ubuntu-mirror

    - name: Configure apt-mirror
      run: |
        echo "deb http://archive.ubuntu.com/ubuntu ${{ github.event.inputs.mirror_url }}" | sudo tee /etc/apt/mirror.list
        echo "deb-src http://archive.ubuntu.com/ubuntu ${{ github.event.inputs.mirror_url }}" | sudo tee /etc/apt/mirror.list
        echo "set base_path /mnt/ubuntu-mirror" | sudo tee -a /etc/apt/mirror.list
        echo "clean /mnt/ubuntu-mirror/var" | sudo tee -a /etc/apt/mirror.list
        echo "set run_postmirror 0" | sudo tee -a /etc/apt/mirror.list
        echo "set defaultarch amd64" | sudo tee -a /etc/apt/mirror.list
        wc -l /etc/apt/mirror.list

    - name: Run apt-mirror
      run: sudo apt-mirror

    - name: Upload mirror to GitHub
      uses: actions/upload-artifact@v4
      with:
        name: "ubuntu-mirror-${{ github.event.inputs.mirror_url }}"
        path: /mnt/ubuntu-mirror

    - name: Clean up
      run: sudo rm -rf /mnt/ubuntu-mirror
