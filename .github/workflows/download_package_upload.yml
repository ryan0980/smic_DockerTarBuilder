name: Download&Package&Upload Hugging Face Model
on:
  workflow_dispatch:
    inputs:
      model_name:
        description: '请填写 Hugging Face 模型名称'
        required: true
        default: 'distilbert-base-uncased'  # 设置默认的 Hugging Face 模型名称

jobs:
  download_and_package:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install necessary tools
      run: |
        sudo apt-get update
        sudo apt-get install wget git-lfs zip

    - name: Get model files list without downloading large files
      run: |
        model_name="${{ github.event.inputs.model_name }}"
        repo_url="https://huggingface.co/${model_name}.git"
        GIT_LFS_SKIP_SMUDGE=1 git clone $repo_url repo
        cd repo
        git ls-tree -r HEAD --name-only > ../file_list.txt
        cd ..
        rm -rf repo
        
    - name: Download files incrementally and handle capacity
      run: |
        model_name="${{ github.event.inputs.model_name }}"
        model_name_sanitized="${model_name//\//.}"
        model_url="https://huggingface.co/${model_name}/resolve/main"
        model_dir="/mnt/model"
        tar_dir="/mnt/tar_parts"
        sudo mkdir -p $tar_dir
        part_size=10240  # 10GB in MB
        current_part=1
        current_size=0
        current_tar="${tar_dir}/${model_name_sanitized}_part${current_part}.tar"
        
        cat file_list.txt | while read file; do
            file_size=$(sudo wget --spider "$model_url/$file" 2>&1 | grep Length | awk '{print $2}')
            new_size=$((current_size + file_size / 1048576))
            
            if [ $new_size -gt $part_size ]; then
                sudo gzip "$current_tar"
                sudo gh api \
                  -X POST \
                  -F "file=@${current_tar}.gz" \
                  -F "name=huggingface-model" \
                  -F "path=${current_tar}.gz"
                sudo rm "${current_tar}.gz"
                
                current_part=$((current_part + 1))
                current_tar="${tar_dir}/${model_name_sanitized}_part${current_part}.tar"
                current_size=0
            fi
            
            sudo wget -P $model_dir "$model_url/$file"
            sudo tar -cvf "$current_tar" "$model_url/$file"
            current_size=$new_size
            sudo rm -f "$model_dir/$file"
        done
    
        sudo gzip "$current_tar"
        sudo gh api \
          -X POST \
          -F "file=@${current_tar}.gz" \
          -F "name=huggingface-model" \
          -F "path=${current_tar}.gz"

    - name: Upload remaining artifact
      run: |
        gh api \
          -X POST \
          -F "file=@${current_tar}" \
          -F "name=huggingface-model" \
          -F "path=$current_tar"
